const def_random={relu:"he_normal",leaky:"he_normal",softmax:"glorot_uniform",sigmoid:"glorot_uniform",tanh:"glorot_uniform",linear:"le_cun",sig_o:"glorot_uniform"};function __inis(t,e,a){e||(e=__def_aktif(t)),a||(a=__def_random(e)),"sigmoid"===e[e.length-1]&&(e[e.length-1]="sig_o");let r=[];for(let e=0;e<t.length-1;e++)for(let n=0;n<t[e+1];n++)for(let n=0;n<t[e]+1;n++)n===t[e]?r.push(0):r.push(__random(a[e],t[e],t[e+1]));return{layer:t,vector_w:r,aktif:e}}function __pred(t,e,a){let r=[[...t]],n=[[]],o=0;for(let i=0;i<e.layer.length-1;i++){let l=[];for(let a=0;a<e.layer[i+1];a++){let a=0;for(let r=0;r<e.layer[i]+1;r++)r===e.layer[i]?a+=e.vector_w[o]:a+=t[r]*e.vector_w[o],o++;l.push(a)}if("final"===a)t=__aktif(e.aktif[i],l);else{let a=__aktif(e.aktif[i],l);r.push(a),n.push(__aktif(e.aktif[i]+"_d",l)),t=a}}return"final"===a?t:{output:t,aktif:r,deriv:n}}function __grad(t,e,a){let r=[],n=a.vector_w.length-1;for(let o=a.layer.length-1;o>0;o--){let i=t.aktif[o-1].map((()=>0));for(let l=a.layer[o]-1;l>-1;l--){let _=e[l]*t.deriv[o][l];for(let e=a.layer[o-1];e>-1;e--)e===a.layer[o-1]?r.unshift(_):(r.unshift(_*t.aktif[o-1][e]),i[e]+=_*a.vector_w[n]),n--}e=i}return r}function __fit(t,e,a,r){a.config.train=!0;for(let n=0;n<t;n++){if(a.config.epoch++,!1===a.config.train)return!1;let t=0,o=[],i=[],l=[];for(let r of e){let e=__pred(r.input,a);o.push(e.output),i.push(r.target),t+=__loss(a.config.loss,e.output,r.target);let n=__loss(a.config.loss+"_d",e.output,r.target);if(l.push(__grad(e,n,a)),l.length===a.config.bacth){let t=__regular(a.config.regular,__mean_grad(l),a);t=__effect(a.config.effect,t,a),__optim(a.config.optimizer,t,a),l=[]}}if(0!==l.length){let t=__regular(a.config.regular,__mean_grad(l),a);t=__effect(a.config.effect,t,a),__optim(a.config.optimizer,t,a)}let _=__akurasi(a.config.akurasi,o,i);r({epoch:n,loss:t/e.length,akurasi:_,config:a.config})}return a.config.train=!1,!1}function __def_aktif(t){const e=[];for(let a=t.length-1;a>0;a--)1===a?e.push("linear"):e.push("relu");return e}function __def_random(t){return t.map((t=>def_random[t]))}function __random(t,e,a){if("glorot_uniform"===t){let t=Math.sqrt(6/(e+a));return Math.random()*(2*t)-t}if("le_cun"===t)return(2*Math.random()-1)/Math.sqrt(e);if("he_uniform"===t){let t=Math.sqrt(6/e);return Math.random()*(2*t)-t}if("he_normal"===t){let t=1-Math.random(),a=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*a)*Math.sqrt(2/e)}if("xavier_normal"===t){let t=1-Math.random(),r=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*r)*Math.sqrt(2/(e+a))}}function __aktif(t,e){if("linear"===t)return e;if("linear_d"===t)return e.map((()=>1));if("relu"===t)return e.map((t=>Math.max(0,t)));if("relu_d"===t)return e.map((t=>t>0?1:0));if("leaky"===t)return e.map((t=>t>0?t:.01*t));if("leaky_d"===t)return e.map((t=>t>0?1:.01));if("softmax"===t){let t=Math.max(...e),a=e.map((e=>Math.exp(e-t))),r=a.reduce(((t,e)=>t+e),0);return a.map((t=>t/r))}return"softmax_d"===t?e.map((t=>1)):"sigmoid"===t?e.map((t=>1/(1+Math.exp(-t)))):"sigmoid_d"===t?e.map((t=>{let e=1/(1+Math.exp(-t));return e*(1-e)})):"tanh"===t?e.map((t=>Math.tanh(t))):"tanh_d"===t?e.map((t=>1-Math.pow(Math.tanh(t),2))):"sig_o"===t?e.map((t=>1/(1+Math.exp(-t)))):"sig_o_d"===t?e.map((()=>1)):void 0}function __loss(t,e,a){return"mse"===t?e.map(((t,e)=>Math.pow(t-a[e],2))).reduce(((t,e)=>t+e),0)/e.length:"mse_d"===t?e.map(((t,r)=>(t-a[r])/e.length)):"ce"===t?-a.map(((t,a)=>t*Math.log(e[a]+1e-15))).reduce(((t,e)=>t+e),0)/e.length:"ce_d"===t?e.map(((t,r)=>(t-a[r])/e.length)):"bce"===t?-a.map(((t,a)=>t*Math.log(e[a]+1e-15)+(1-t)*Math.log(1-e[a]+1e-15))).reduce(((t,e)=>t+e),0)/e.length:"bce_d"===t?e.map(((t,r)=>(t-a[r])/e.length)):"mae"===t?e.map(((t,e)=>Math.abs(t-a[e]))).reduce(((t,e)=>t+e),0)/e.length:"mae_d"===t?e.map(((t,r)=>Math.sign(t-a[r])/e.length)):void 0}function __optim(t,e,a){if("sgd"===t){let t=a.config.learning_rate,r=a.vector_w;for(let a=0;a<r.length;a++)r[a]-=e[a]*t;return!1}if("momentum"===t){a.config.momentum||_default_optimizer_data("momentum",a);let t=a.config.momentum.beta,r=a.config.momentum.velocity,n=a.vector_w,o=a.config.learning_rate;for(let a=0;a<n.length;a++)r[a]=t*r[a]+e[a],n[a]-=r[a]*o;return!1}if("adam"===t){a.config.adam||_default_optimizer_data("adam",a);let t=a.config.adam,r=a.config.learning_rate,n=a.vector_w;t.time_step++;for(let a=0;a<n.length;a++){t.momentum[a]=t.beta_1*t.momentum[a]+(1-t.beta_1)*e[a],t.velocity[a]=t.beta_2*t.velocity[a]+(1-t.beta_2)*Math.pow(e[a],2);let o=t.momentum[a]/(1-Math.pow(t.beta_1,t.time_step)),i=t.velocity[a]/(1-Math.pow(t.beta_2,t.time_step));n[a]-=r*o/(Math.sqrt(i)+t.epsilon)}return!1}}function _default_optimizer_data(t,e){return"momentum"===t?(e.config.momentum={beta:.9,velocity:new Array(e.vector_w.length).fill(0)},!1):"adam"===t?(e.config.adam={time_step:0,beta_1:.9,beta_2:.99,epsilon:1e-15,momentum:new Array(e.vector_w.length).fill(0),velocity:new Array(e.vector_w.length).fill(0)},!1):void 0}function __regular(t,e,a){if("none"===t)return e;if("l2"===t){const t=a.config.lambda;return e.map(((e,r)=>e+t*a.vector_w[r]))}if("l1"===t){const t=a.config.lambda;return e.map(((e,r)=>e+t*Math.sign(a.vector_w[r])))}}function __mean_grad(t){let e=new Array(t[0].length).fill(0);for(let a=0;a<t.length;a++)for(let r=0;r<t[a].length;r++)e[r]+=t[a][r];return e.map((e=>e/t.length))}function __akurasi(t,e,a){if("none"===t)return{mtr_pred:e,mtr_target:a}}function __effect(t,e,a){if("none"===t)return e}function __config(t,e,a){if("default"===t||"custom"===t)e.config={learning_rate:.01,loss:"mse",optimizer:"sgd",regular:"none",akurasi:"none",batch:1,train:!1,epoch:0,lambda:.01,effect:"none"},"custom"===t&&a(e.config);else{if("momentum"===t)return _default_optimizer_data("momentum",e),a(e.config.momentum),!1;if("adam"===t)return _default_optimizer_data("adam",e),a(e.config.adam),!1}}class Vignette{constructor(){this.type="Vignette_MLP v3.0",this.author="Nidkawai"}order(t,e,a){return this.model=__inis(t,e,a),"Model siap!"}config(t,e){return __config(t,this.model,e),"Config siap"}set_data(t,e){"default"===t&&(this.data_set=e)}quest(t){return __pred(t,this.model,"final")}quest_all(t){return __pred(t,this.model)}fit(t,e){return __fit(t,this.data_set,this.model,e),"Train selesai!"}model_json(t){let e={vector_w:this.model.vector_w,layer:this.model.layer,aktif:this.model.aktif,nama_lib:"Vignette_MLP",penulis:"Nidkawai"};return t?"cute"===t?JSON.stringify(e,null,2):void 0:JSON.stringify(e)}}
